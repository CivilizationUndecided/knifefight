@namespace Facepunch.UI
@inherits Panel
@attribute [StyleSheet]

<root>
    @foreach ( var entry in Entries )
    {
        <div class="entry @(entry.IsLocal ? "local" : "")">
            @if ( entry.DamageEvent.Attacker.IsValid() )
            {
                <PlayerPanel Player=@GameUtils.GetPlayerFromComponent( entry.DamageEvent.Attacker ) />
            }

            <div class="method">
                @if ( GameUtils.GetWeaponFromComponent( entry.DamageEvent.Inflictor ) is {} weapon )
                {
                    <div class="icon" style="background-image: url( @weapon.Resource.Icon );" />

                    @if ( entry.DamageEvent.Hitboxes.Contains( "head" ) )
                    {
                        <Icon class="headshot" File="/ui/headshot.png" size="32" />
                    }
                }
                else if ( entry.DamageEvent.Inflictor is TimedExplosive bomb )
                {
                    <Icon File="/ui/bomb.png" size="32"></Icon>
                }
                else
                {
                    <label>killed</label>
                }
            </div>

            @if ( entry.DamageEvent.Victim.IsValid() )
            {
                <PlayerPanel Player=@GameUtils.GetPlayerFromComponent( entry.DamageEvent.Victim ) />
            }
        </div>
    }
</root>

@code
{
    public record Entry( DamageEvent DamageEvent, RealTimeSince TimeSinceAdded )
    {
        public bool IsLocal => 
            (GameUtils.GetPlayerFromComponent(DamageEvent.Attacker)?.IsLocallyControlled ?? false) ||
            (GameUtils.GetPlayerFromComponent(DamageEvent.Victim)?.IsLocallyControlled ?? false);
    }

    private List<Entry> Entries { get; set; } = new();

    private float Lifetime => 10f;

    public void OnPlayerKilled( DamageEvent damageEvent )
    {
        var entry = new Entry( damageEvent, 0 );
        Entries.Add( entry );
        StateHasChanged();
    }

    public override void Tick()
    {
        // Limit entries so we don't get too busy
        Entries = Entries.TakeLast( 5 ).ToList();

        // Did we remove something?
        if ( Entries.RemoveAll( x => x.TimeSinceAdded > Lifetime ) > 0 )
        {
            StateHasChanged();
        }
    }
}