@namespace Facepunch.UI
@inherits Panel
@attribute [StyleSheet]

<root>
    <div @ref="Reticle" class="reticle" />
    <div @ref="Hitmarker" class="hitmarker @HitmarkerClasses" />
</root>

@code
{
    public Panel Reticle { get; set; }
    public Panel Hitmarker { get; set; }

    PlayerController Player => GameUtils.LocalPlayer;
    Weapon Weapon => Player.CurrentWeapon;

    private TimeUntil TimeUntilHitmarkerRemove = 0f;
    private float HitMarkerDuration => 0.1f;

    public static Crosshair Instance { get; set; }

    protected override void OnAfterTreeRender( bool firstTime )
    {
        if ( firstTime )
        {
            Instance = this;
        }
    }

    string HitmarkerClasses => !TimeUntilHitmarkerRemove ? "is-visible" : string.Empty;

    public void Trigger( float damage, Component component, Vector3 position )
    {
        var isKill = damage <= 0f;
        TimeUntilHitmarkerRemove = isKill ? 0.5f : 0.2f;
        Hitmarker.SetClass( "is-kill", isKill );
    }

    public override void Tick()
    {
        var player = Player;
        if ( !player.IsValid() ) return;
        
        var camera = player.CameraController.Camera;
        var range = 100000f;
        var muzzle = Weapon?.ViewModel?.ModelRenderer.GetAttachment( "muzzle" );
        var origin = muzzle.HasValue ? muzzle.Value.Position : camera.Transform.Position;

        var currentTrace = player.Scene.Trace.Ray( origin, camera.Transform.Rotation.Forward * range )
            .IgnoreGameObjectHierarchy( player.GameObject )
            .UseHitboxes()
            .Run();

        Reticle.SetClass( "aiming", Weapon?.GetFunction<AimWeaponFunction>()?.IsAiming ?? false );
        
        if ( currentTrace.Hit )
        {
            var enemy = currentTrace.GameObject.Root.Components.Get<PlayerController>();
            Reticle.SetClass( "enemy", enemy.IsValid() );
        }
        else
        {
            Reticle.SetClass( "enemy", false );
        }
    }

    protected override int BuildHash()
    {
        return HashCode.Combine( Time.Now );
    }
}
