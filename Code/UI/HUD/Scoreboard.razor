@using System;
@using Sandbox.UI;

@namespace Facepunch.UI
@inherits Panel

@attribute [StyleSheet]

<root class="center with-background with-padding-lg">
    <table>
        <div class="title">
            <label class="important">@Status</label>
            <label class="important">@(Time?.ToString(@"m\:ss"))</label>
        </div>

        @foreach ( var group in GroupedPlayers )
        {
            @if ( group.Key == Team.Unassigned )
            {
                <div class="flex gap-sm align-center">
                    <Icon file="/ui/teams/spectator.png" size="16" />
                    <label class="small grey">@(string.Join(", ", group.Select(x => x.GetPlayerName()))</label>
                </div>
            }
            else
            {
                <span class="flex align-center space-between gap-sm" style="color: @group.Key.GetColor().Hex">
                    <span class="flex align-center gap-sm">
                        <Icon file="@group.Key.GetIconPath()" size="24" style="background-image-tint: @group.Key.GetColor().Hex" />
                        <label class="emphasis with-py">@group.Key.GetName()</label>
                    </span>

                    <separator style="background-color: @group.Key.GetColor().Hex" />

                    @if ( GameMode.Instance.Components.GetInDescendantsOrSelf<TeamScoring>() is { } scoring )
                    {
                        <label class="emphasis">@scoring.GetTeamScore(group.Key)</label>
		            }
                </span>

                <div class="row header with-px-lg with-py-sm">
                    <label class="col stat-small small"></label>
                    <label class="col stat-small small"></label>
                    <label class="col playername small"></label>
                    <label class="col stat-large small">Balance</label>
                    <label class="col stat small">Score</label>
                    <label class="col stat small">Kills</label>
                    <label class="col stat small">Deaths</label>
                    <label class="col stat small">Ratio</label>
                </div>

                @foreach ( var player in group )
                {
                    <ScoreboardRow Player="@player" />
                }
            }
        }
    </table>
</root>

@code
{
    public string Status => GameMode.Instance?.DisplayedStatus;
    public TimeSpan? Time => GameMode.Instance?.DisplayedTime;

    public IEnumerable<PlayerController> PlayerList => Scene.GetAllComponents<PlayerController>();

    private List<IGrouping<Team, PlayerController>> GroupedPlayers
    {
        get
        {
            var sortedPlayers = PlayerList.OrderByDescending(x => x.Components.Get<PlayerScore>().Score);
            var groupedPlayers = sortedPlayers.GroupBy(x => x.TeamComponent.Team);
            return groupedPlayers.ToList();
        }
    }

    public bool IsActive => Input.Down("score");

    protected override int BuildHash()
    {
        return HashCode.Combine(GroupedPlayers, Status, Time, GameUtils.AllPlayers, IsActive);
    }

    public override void Tick()
    {
        SetClass( "active", IsActive );
    }
}
