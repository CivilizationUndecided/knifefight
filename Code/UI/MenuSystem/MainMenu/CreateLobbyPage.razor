@using Sandbox;
@using Sandbox.Network
@using Sandbox.UI;

@inherits Panel
@implements INavigatorPage
@namespace Facepunch.UI

<root class="hc1">
    <div class="layout padding-insane column">
        <div class="logo">
            <img src="/ui/teams/operators_logo_banner.png" />
        </div>
    </div>

    <div class="layout flex-grow" />

    <div class="layout padding-insane column gap" style="width: 100%;">
        <label class="text">Map</label>
        <MapList SelectedMap:bind=@SelectedMap GameMode:bind=@SelectedGameMode OnSelected=@OnMapSelected />

        <label class="text">Game mode</label>
        <GameModeList SelectedGameMode:bind=@SelectedGameMode @ref="GameModeList" />
    </div>

    <div class="layout flex-grow" />

    <div class="layout padding-insane column" style="width: 30%;">
        <div class="layout column gap">
            <div class="button standard" onclick=@Join>start game</div>
            <a class="button standard" href="/">return</a>
        </div>
    </div>
</root>

@code
{
    public MapDefinition SelectedMap { get; set; }
    public GameModeInfo SelectedGameMode { get; set; }

    public GameModeList GameModeList { get; set; }

    public void OnMapSelected( MapDefinition map )
    {
        GameModeList.Filter( map );
        SelectedGameMode = GameModeList.GameModes.FirstOrDefault();
    }

    protected override void OnAfterTreeRender( bool firstTime )
    {
        if ( !firstTime )
            return;

        SelectedMap = MapSystem.All.FirstOrDefault();
        SelectedGameMode = GameMode.GetAll( SelectedMap.SceneFile ).FirstOrDefault();
        GameModeList.Filter( SelectedMap );
    }

    private void Join()
    {
        if (SelectedGameMode is null)
            return;

        if (SelectedMap is null)
            return;

        GameMode.ActivePath = SelectedGameMode?.Path;
        Game.ActiveScene.Load( SelectedMap.SceneFile );
    }
}
